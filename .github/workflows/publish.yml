name: Publish to PyPI

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      should_bump_version:
        description: 'Whether to bump the version before publishing'
        required: true
        default: false
        type: boolean
      version_type:
        description: 'Version type to bump (major, minor, patch) - only used if should_bump_version is true'
        required: false
        default: 'patch'
        type: choice
        options:
        - major
        - minor
        - patch

permissions:
  contents: write
  pull-requests: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.12"
        
    - name: Set up Git user
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        
    - name: Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        source "$HOME/.cargo/env"
    
    - name: Install build tools
      run: |
        uv pip install --system build twine
        
    - name: Install dependencies
      run: |
        uv pip install --system toml-cli
        
    - name: Bump version in pyproject.toml (only when requested)
      id: version_bump
      if: ${{ github.event_name == 'workflow_dispatch' && inputs.should_bump_version == true }}
      run: |
        # Read current version from pyproject.toml
        CURRENT_VERSION=$(toml get --toml-path pyproject.toml project.version | sed 's/"//g')
        echo "Current version: $CURRENT_VERSION"
        
        # Parse version components
        IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
        MAJOR=${VERSION_PARTS[0]}
        MINOR=${VERSION_PARTS[1]}
        PATCH=${VERSION_PARTS[2]}
        
        # Determine new version based on input
        if [[ "${{ inputs.version_type }}" == "major" ]]; then
          NEW_VERSION="$((MAJOR + 1)).0.0"
        elif [[ "${{ inputs.version_type }}" == "minor" ]]; then
          NEW_VERSION="${MAJOR}.$((MINOR + 1)).0"
        else
          # Default to patch
          NEW_VERSION="${MAJOR}.${MINOR}.$((PATCH + 1))"
        fi
        
        echo "New version: $NEW_VERSION"
        
        # Update pyproject.toml with the new version
        toml set --toml-path pyproject.toml project.version "$NEW_VERSION"
        
        # Output new version for use in later steps
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
    
    - name: Commit and push version changes (only when version was bumped)
      if: ${{ github.event_name == 'workflow_dispatch' && inputs.should_bump_version == true }}
      run: |
        git add pyproject.toml
        git commit -m "Bump version from ${{ steps.version_bump.outputs.current_version }} to ${{ steps.version_bump.outputs.new_version }}"
        git push origin main
    
    - name: Create and push Git tag (only when version was bumped)
      if: ${{ github.event_name == 'workflow_dispatch' && inputs.should_bump_version == true }}
      run: |
        git tag "v${{ steps.version_bump.outputs.new_version }}"
        git push origin "v${{ steps.version_bump.outputs.new_version }}"
    
    - name: Build package
      run: |
        python -m build
        
    - name: Publish to PyPI
      env:
        UV_PUBLISH_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        uv publish
    
    - name: Generate release notes (only when version was bumped)
      id: release_notes
      if: ${{ github.event_name == 'workflow_dispatch' && inputs.should_bump_version == true }}
      run: |
        # Get the previous tag to determine what changed
        PREV_TAG=$(git tag --sort=-version:refname | sed -n 2p)
        
        # Also set a message for the release
        if [ -z "$PREV_TAG" ]; then
          echo "message=Initial release with all features and fixes" >> $GITHUB_OUTPUT
        else
          echo "message=What's Changed" >> $GITHUB_OUTPUT
        fi
        
        if [ -z "$PREV_TAG" ]; then
          # If no previous tag exists, show all commits
          COMMITS=$(git log --oneline --no-merges)
        else
          # Get commits between the previous tag and current HEAD
          COMMITS=$(git log --oneline --no-merges "$PREV_TAG..HEAD")
        fi
        
        # Format the commits for the release body
        echo "commits<<EOF" >> $GITHUB_OUTPUT
        echo "$COMMITS" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create GitHub Release (only when version was bumped)
      if: ${{ github.event_name == 'workflow_dispatch' && inputs.should_bump_version == true }}
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ steps.version_bump.outputs.new_version }}
        release_name: Release v${{ steps.version_bump.outputs.new_version }}
        body: |
          Release version ${{ steps.version_bump.outputs.new_version }}
          
          ${{ steps.release_notes.outputs.message }}:
          ```
          ${{ steps.release_notes.outputs.commits }}
          ```
        draft: false
        prerelease: false